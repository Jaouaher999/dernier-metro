openapi: 3.0.3
info:
  title: Dernier Metro API
  version: "1.0.0"

servers:
  - url: http://localhost:3000

paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: ok
                service: dernier-metro-api

  /db-health:
    get:
      summary: Database health check
      responses:
        "200":
          description: Database reachable
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok]
                  result:
                    type: object
                    properties:
                      TEST:
                        type: integer
                        example: 1
                required: [status, result]
              example:
                status: ok
                result:
                  TEST: 1
        "500":
          description: Database degraded/unreachable
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: degraded
                  error:
                    type: string
                required: [status, error]
              example:
                status: degraded
                error: connection timeout

  /stations:
    get:
      summary: List stations
      responses:
        "200":
          description: Array of station names
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /next-metro:
    get:
      summary: Next metro for a station
      description: |
        Returns next arrivals for a given station.
        - Requires `station` query param.
        - Optional `n` (1..5) returns multiple arrivals.
        - When service is closed, returns a closed payload with timezone.
      parameters:
        - in: query
          name: station
          required: true
          schema:
            type: string
        - in: query
          name: n
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 5
          description: Number of next arrivals to return (1..5)
      responses:
        "200":
          description: Next arrivals or closed service
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ServiceClosed"
                  - $ref: "#/components/schemas/SingleArrival"
                  - $ref: "#/components/schemas/MultipleArrivals"
              examples:
                closed:
                  value:
                    service: closed
                    tz: Europe/Paris
                single:
                  value:
                    station: Chatelet
                    line: M1
                    headwayMin: 3
                    nextArrival: "12:34"
                    isLast: false
                    tz: Europe/Paris
                multiple:
                  value:
                    station: Chatelet
                    line: M1
                    headwayMin: 3
                    tz: Europe/Paris
                    arrivals:
                      - time: "12:34"
                        isLast: false
                      - time: "12:37"
                        isLast: false
                      - time: "12:40"
                        isLast: false
        "400":
          description: Missing station parameter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error400MissingStation"
              example:
                error: missing station
        "404":
          description: Unknown station (with suggestions)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error404UnknownStation"
              examples:
                withSuggestions:
                  value:
                    error: unknown station
                    station: Chate
                    suggestions: ["Chatelet", "La Defense", "Bastille"]
                noSuggestions:
                  value:
                    error: unknown station
                    station: Zzz
                    suggestions: []

  /last-metro:
    get:
      summary: Last metro time for a station
      description: |
        Reads last metro configuration from the `config` table using keys:
        - `metro.defaults` (JSON: { line, tz })
        - `metro.last` (JSON object map: StationName -> "HH:MM")
        Requires `station` query param (case-insensitive match).
      parameters:
        - in: query
          name: station
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Last metro info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LastMetroResponse"
              example:
                station: Chatelet
                lastMetro: "01:15"
                line: M1
                tz: Europe/Paris
        "400":
          description: Missing station parameter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error400MissingStation"
              example:
                error: missing station
        "404":
          description: Unknown station
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error404UnknownStationSimple"
              example:
                error: unknown station
                station: Zzz
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error500Internal"
              example:
                error: internal_error

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
        service:
          type: string
      required: [status]

    ServiceClosed:
      type: object
      properties:
        service:
          type: string
          enum: [closed]
        tz:
          type: string
      required: [service, tz]

    SingleArrival:
      type: object
      properties:
        station:
          type: string
        line:
          type: string
        headwayMin:
          type: integer
        nextArrival:
          type: string
          pattern: '^\d{2}:\d{2}$'
        isLast:
          type: boolean
        tz:
          type: string
      required: [station, line, headwayMin, nextArrival, isLast, tz]

    MultipleArrivals:
      type: object
      properties:
        station:
          type: string
        line:
          type: string
        headwayMin:
          type: integer
        tz:
          type: string
        arrivals:
          type: array
          items:
            type: object
            properties:
              time:
                type: string
                pattern: '^\d{2}:\d{2}$'
              isLast:
                type: boolean
            required: [time, isLast]
      required: [station, line, headwayMin, tz, arrivals]

    LastMetroResponse:
      type: object
      properties:
        station:
          type: string
        lastMetro:
          type: string
          pattern: '^\d{2}:\d{2}$'
        line:
          type: string
        tz:
          type: string
      required: [station, lastMetro, line, tz]

    Error400MissingStation:
      type: object
      properties:
        error:
          type: string
      required: [error]

    Error404UnknownStation:
      type: object
      properties:
        error:
          type: string
          example: unknown station
        station:
          type: string
        suggestions:
          type: array
          items:
            type: string
      required: [error, station, suggestions]

    Error404UnknownStationSimple:
      type: object
      properties:
        error:
          type: string
        station:
          type: string
      required: [error, station]

    Error500Internal:
      type: object
      properties:
        error:
          type: string
          example: internal_error
      required: [error]
